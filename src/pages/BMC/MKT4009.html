<!DOCTYPE html>
<html lang="ko">
    @@include('./common/head.html', {
        pageCSS: ["BMC/BMC"],
        pageJS: ["caresolution/addressManagement"]
    })
<body>
    <article id="popup" class="win-popup-wrap uiForm"
        data-event-id = "eventID_TEST"
        data-sku-url = "/lg5-common/data-ajax/mypage/product/checkSku.json"
    >
        <header class="pop-header">
            <h1 class="tit"><span>이벤트 참여하기</span></h1>
        </header>
        <section class="pop-conts academy-pop">
            <div class="input-info">
                <div class="tit-wrap">
                    <!-- 210126 수정 - 타이틀 번호 삭제  -->
                    <h2 class="h2-tit">구매정보</h2>
                </div>
                <div class="form-wrap">
                    <dl class="forms">
                        <dt class="tit"><label for="buyerName">구매자 이름</label></dt>
                        <dd class="conts">
                            <span class="input-wrap">
                                <input type="text" class="disabled" name="buyerName" value="" data-required="true" id="buyerName" placeholder="이름을 입력해 주세요." readonly>
                            </span>
                        </dd>
                    </dl>
                    <dl class="forms">
                        <dt class="tit">
                            <label for="buyerPhone">휴대폰</label>
                            <!-- 210126 수정 - 툴팁 삭제
                            <div class="tooltip-wrap"> !-- 활성화시 active --
                                <span class="tooltip-icon ui_tooltip-target">자세히 보기</span>
                                <span class="tooltip-box">
                                    <p>LG전자 회원가입 시 입력한 휴대폰 번호로 응모 됩니다.</p>
                                    <button type="button" class="btn-close"><span class="blind">닫기</span></button>
                                </span>
                            </div> -->
                        </dt>
                        <dd class="conts">
                            <div class="input-wrap">
                                <input type="number" class="disabled" name="buyerPhone" data-required="true" id="buyerPhone" value="" placeholder="‘-’없이 번호만 입력해 주세요." readonly>
                            </div>
                            <!-- 210126 수정 - 돔 추가 -->
                            @@include('./common/modules/bullet-list.html', {
                                "bulletTxt" : [
                                    "LG전자 회원가입 시 입력한 휴대폰 번호로 응모 됩니다."
                                ]
                            })
                            <!-- // 210126 수정 -->
                        </dd>
                    </dl>
                    <dl class="forms">
                        <dt class="tit"><label for="modelName" class="req">모델명<span class="blind">필수입력</span></label></dt>
                        <dd class="conts">
                            <div class="input-wrap">
                                <input type="text" name="modelName" data-required="true" id="modelName" placeholder="모델명을 입력해 주세요.">
                            </div>
                        </dd>
                    </dl>
                    <dl class="forms">
                        <dt class="tit"><label for="serialNum" class="req">제조번호(S/N)<span class="blind">필수입력</span></label></dt>
                        <dd class="conts">
                            <div class="box">
                                <div class="input-wrap">
                                    <input type="text" name="serialNum" data-required="true" id="serialNum" placeholder="S/N을 입력해 주세요.">
                                    <p class="link"><a href="#" data-control="modal" id="serialPopupBtn" class="btn-link">제품 제조번호 확인방법</a></p>
                                </div>
                                <div class="cell">
                                    <button type="button" class="btn" id="serialCheckBtn"><span>제조번호 확인</span></button>
                                </div>
                            </div>
                        </dd>
                    </dl>
                    <dl class="forms">
                        <dt class="tit"><label for="buyerAddr" class="req">구매자 주소<span class="blind">필수입력</span></label></dt>
                        <dd class="conts">
                            <div class="address-box">
                                <div class="box">
                                    <div class="input-wrap zip-code">
                                        <input type="text" class="disabled" name="buyerZipCode" data-required="true" id="buyerAddr" placeholder="우편번호" readonly>
                                    </div>
                                    <div class="cell">
                                        <button type="button" class="btn" id="buyerAddrBtn"><span>주소 찾기</span></button>
                                    </div>
                                </div>
                                <div class="input-wrap">
                                    <input type="text" class="disabled" name="buyerAddrInfo" data-required="true" value="" placeholder="주소 찾기를 선택해 주세요." readonly>
                                </div>
                            </div>
                            <div class="input-wrap">
                                <input type="text" name="buyerAddrDetail" data-required="true" placeholder="상세주소를 입력해주세요.">
                            </div>
                        </dd>
                    </dl>
                </div>
            </div>

            <div class="input-info">
                <div class="tit-wrap">
                    <!-- 210126 수정 - 타이틀 번호 삭제 / 체크박스 돔 이동  -->
                    <h2 class="h2-tit">사은품 배송 정보</h2>
                    <div class="chk-input">
                        <span class="chk-wrap">
                            <input type="checkbox" id="info" name="info">
                            <label for="info">구매자 정보와 같음</label>
                        </span>
                    </div>
                    <!-- // 210126 수정  -->
                </div>
                <div class="form-wrap">
                    <dl class="forms">
                        <dt class="tit"><label for="recipientName" class="req">수령자 이름<span class="blind">필수입력</span></label></dt>
                        <dd class="conts">
                            <div class="input-wrap">
                                <input type="text" name="recipientName" data-required="true" id="recipientName" placeholder="이름을 입력해 주세요." value="">
                            </div>
                        </dd>
                    </dl>
                    <dl class="forms">
                        <dt class="tit">
                            <label for="recipientPhone" class="req">휴대폰<span class="blind">필수입력</span></label>
                        </dt>
                        <dd class="conts">
                            <div class="input-wrap">
                                <input type="text" name="recipientPhone" data-required="true" id="recipientPhone" placeholder="‘-’없이 번호만 입력해 주세요.">
                            </div>
                        </dd>
                    </dl>
                    <dl class="forms">
                        <dt class="tit">
                            <label for="recipientAddr" class="req">수령자 주소<span class="blind">필수입력</span></label>
                            <!-- 210126 수정 - 툴팁 삭제
                            <div class="tooltip-wrap"> !-- 활성화시 active --
                                <span class="tooltip-icon ui_tooltip-target">자세히 보기</span>
                                <span class="tooltip-box">
                                    <p>입력한 정보로 배송되니 정확한 배송지를 확인해주세요.<br>
                                    주소는 사은품 발송의 목적으로, 해당 이벤트 참여용으로만 수집합니다.</p>
                                    <button type="button" class="btn-close"><span class="blind">닫기</span></button>
                                </span>
                            </div>
                             -->
                        </dt>
                        <dd class="conts">
                            <div class="address-box">
                                <div class="box">
                                    <div class="input-wrap zip-code">
                                        <input type="text" class="disabled" name="recipientZipCode" data-required="true" id="recipientAddr" placeholder="우편번호" readonly>
                                    </div>
                                    <div class="cell">
                                        <button type="button" class="btn" id="recipientAddrBtn"><span>주소 찾기</span></button>
                                    </div>
                                </div>
                                <div class="input-wrap">
                                    <input type="text" class="disabled" name="recipientAddrInfo" data-required="true" value="" placeholder="주소 찾기를 선택해 주세요." readonly>
                                </div>
                            </div>
                            <div class="input-wrap">
                                <input type="text" name="recipientAddrDetail" data-required="true" placeholder="상세주소를 입력해주세요.">
                            </div>
                            <!-- 210126 수정 - 돔 추가 -->
                            @@include('./common/modules/bullet-list.html', {
                                "bulletTxt" : [
                                    "입력한 정보로 배송되니 정확한 배송지를 확인해주세요.",
                                    "주소는 사은품 발송의 목적으로, 해당 이벤트 참여용으로만 수집합니다."
                                ]
                            })
                            <!-- // 210126 수정 -->
                        </dd>
                    </dl>
                </div>
            </div>

            <div class="input-info"><!-- 210126 수정 - .input-info 영역 내 돔 변경이 있음 -->
                <div class="input-info-wrap"><!-- 210126 수정 - .input-info-wrap 돔 추가 -->
                    <div class="tit-wrap">
                        <!-- 210126 수정 - 타이틀 번호 삭제  -->
                        <h2 class="h2-tit">개인정보 수집 이용 및 처리 위탁 동의</h2>
                    </div>
                    <!-- 210126 수정 - 필수 표시 변경 -->
                    <p class="tb-tit req">개인정보 수집 이용 동의<span class="blind">필수</span></p>
                    <div class="tb_row tb-bor">
                        <table>
                            <caption>개인정보 수집 이용 동의 수집항목, 목적, 보유기간 안내</caption>
                            <colgroup>
                                <col style="width:25%">
                                <col style="width:25%">
                                <col style="width:25%">
                                <col>
                            </colgroup>
                            <thead>
                            <tr>
                                <th scope="col">수집항목</th>
                                <th scope="col">목적</th>
                                <th scope="col">보유기간</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td class="al-left">구매자 이름, 구매자 연락처, 구매자 주소</td>
                                <td class="al-left">이벤트 응모내역 확인 시 본인 확인</td>
                                <td rowspan="3" class="al-left">이벤트 종료일로부터 3개월까지 보유 후 파기</td>
                            </tr>
                            <tr>
                                <td class="al-left">수령자 이름, 수령자 연락처</td>
                                <td class="al-left">경품배송 시 본인 확인</td>
                            </tr>
                            <tr>
                                <td class="al-left">수령자 주소</td>
                                <td class="al-left">경품배송</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    @@include('./common/modules/bullet-list.html', {
                        "bulletTxt" : [
                            "귀하께서는 본 동의를 거절하실 수 있습니다. 단, 거절하신 경우 이벤트 참여가 제한될 수 있습니다.",
                            "14세 미만 고객의 경우, 이벤트 참여가 제한됩니다."
                        ]
                    })
                    <div class="agree-input">
                            <span class="chk-wrap">
                                <input type="checkbox" id="chk1-1" name="agreechk-1" data-required="true" >
                                <label for="chk1-1">동의합니다</label>
                            </span>
                    </div>
                </div><!-- 210126 수정 - .input-info-wrap 돔 추가 -->
                <div class="input-info-wrap"><!-- 210126 수정 - 클래스 수정 -->
                    <!-- 210126 수정 - 필수 표시 변경 -->
                    <p class="tb-tit req">개인정보 처리 위탁 동의<span class="blind">필수</span></p>
                    <div class="tb_row tb-bor">
                        <table>
                            <caption>개인정보 처리 위탁 동의 수탁자, 목적 안내</caption>
                            <colgroup>
                                <col style="width:50%">
                                <col style="">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th scope="col">수탁자</th>
                                    <th scope="col">목적</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>(주)LG CNS, 원은</td>
                                    <td>경품 제공 등 이벤트와 관련한 업무</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    @@include('./common/modules/bullet-list.html', {
                        "bulletTxt" : [
                            "경품 제공 등 이벤트 진행을 위한 개인정보 처리 위탁에 동의하셔야 이벤트 참여가 가능합니다."
                        ]
                    })
                    <div class="agree-input">
                        <span class="chk-wrap">
                            <input type="checkbox" id="chk2-1" name="agreechk-2" data-required="true" >
                            <label for="chk2-1">동의합니다</label>
                        </span>
                    </div>
                </div>

                <div class="input-info-wrap"><!-- 210126 수정 - 클래스 수정 -->
                    <p class="tb-tit">개인정보 수집 이용 동의(선택)</p>
                    <div class="tb_row tb-bor">
                        <table>
                            <caption>개인정보 수집 이용 동의 수탁자, 목적, 보유기간 안내</caption>
                            <colgroup>
                                <col style="width:33.3%">
                                <col style="width:33.3%">
                                <col style="">
                            </colgroup>
                            <thead>
                            <tr>
                                <th scope="col">수탁자</th>
                                <th scope="col">목적</th>
                                <th scope="col">보유기간</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>생년, 성별</td>
                                <td>마케팅 또는 통계를 위한 참고 및 활용</td>
                                <td>이벤트 종료일로부터 3개월까지 보유 후 파기</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    @@include('./common/modules/bullet-list.html', {
                        "bulletTxt" : [
                            "귀하께서는 본 동의를 거절하실 수 있습니다."
                        ]
                    })
                    <div class="agree-input">
                        <span class="chk-wrap">
                            <input type="checkbox" id="chk3-1" name="agreechk-3" data-required="true">
                            <label for="chk3-1">동의합니다</label>
                        </span>
                    </div>
                </div>
            </div>

        </section>
        <footer class="pop-footer center">
            <div class="btn-group">
                <button type="button" class="btn pink" id="uiSubmit"><span>신청하기</span></button>
            </div>
        </footer>
        <button type="button" class="win-btn-close"><span class="blind">닫기</span></button>
    </article>

    <article id="serialPopup" class="popup-wrap" data-list-url="/lg5-common/data-ajax/support/searchModelName.json">
        <!-- 210126 수정 - 전체 화면 변경 -->
        <header class="pop-header">
            <h1 class="tit"><span>모델명 확인 방법</span></h1>
        </header>
        <section class="pop-conts common-pop academy-pop no-footer"><!-- [11.27 수정] common-pop Class 추가 -->
            <p class="noti-txt">사용하시는 제품의 <em>모델명</em>과 <em>제조번호</em>를 확인해주세요.</p>
            <div class="example-list">
                <dl>
                    <dt>모델명</dt>
                    <dd>PRODUCT CODE 나 SVC CODE 또는 제품 CODE로 확인</dd>
                </dl>
                <dl>
                    <dt>제조번호</dt>
                    <dd>SERIAL NO(S/N) 또는 일련번호로 확인</dd>
                </dl>
                <dl class="sel-category">
                    <dt>카테고리 선택</dt>
                    <dd>
                        <div class="select-wrap">
                            <select class="ui_selectbox" id="select1" title="카테고리 선택">
                                <option value="" class="placeholder">TV/AV</option>
                                <option value="">카테고리</option>
                            </select>
                        </div>
                    </dd>
                    <dd>
                        <div class="select-wrap">
                            <select class="ui_selectbox" id="select2" title="세부 카테고리 선택" disabled>
                                <option value="" class="placeholder">세부 카테고리 선택</option>
                                <option value="">세부 카테고리</option>
                            </select>
                        </div>
                    </dd>
                </dl>

                <div class="example-result">
                    <p class="txt">제품 카테고리를 선택하면, 해당 제품의 모델명 확인 방법을 안내해 드립니다.</p>
                    <div class="img" aria-hidden="true">
                        <!-- 
                            제품 이미지 없을 경우
                            <img src="/lg5-common/images/img-nodata.svg" alt=""> 
                        -->
                        <img src="/lg5-common/images/dummy/@img-example.jpg" alt="">
                    </div>
                </div>

            </div>
        </section>
        <button type="button" class="win-btn-close"><span class="blind">닫기</span></button>
    </article>
    
    <script>
        $(function () {
            
            vcui.require(['ui/validation','ui/modal','ui/selectbox'], function (Validation) {

                // 구매자 정보 셋팅값 입력
                var buyerInfo = {
                    buyerName : { value:'홍길동' },
                    buyerPhone: { value:'01023457890'},
                    buyerZipCode: { value:'02345' },
                    buyerAddrInfo: { value:'서울시' },
                    buyerAddrDetail: { value:'엘지 송파빌딩 1702호' }
                }

                var addAddressObj = {}
                $.each(buyerInfo, function(key, value){
                    var newKey = key.replace('buyer','recipient');
                    addAddressObj[newKey] = value;
                })

                
                // 구매자 정보를 비움
                var emptyAddAddressObj = {
                    recipientName:'',
                    recipientPhone:'',
                    recipientZipCode:'',
                    recipientAddrInfo:'',
                    recipientAddrDetail:''
                }
                var vaildObj = {
                    modelName:{
                        required: true,
                        errorMsg: "모델명을 입력해 주세요.",
                    },
                    serialNum:{
                        required: true,
						validate : function(val){
							var reg = /^\d{3}[A-Za-z]{4}[\d\A-Za-z]{5,7}$/
							return reg.test(val);
						},
                        errorMsg: "제조번호를 입력해 주세요.",
					}
                }

                var errorObj = {}; // 에러 담는곳
                $('#serialNum').css('text-transform', 'uppercase'); // 시리얼넘버 대문자만

				var validation = new Validation('.uiForm',{register:$.extend(buyerInfo, vaildObj)});
                
                validation.on('errors', function(e,data){
                    errorObj = data;

                }).on('success', function(data){
                    // 성공시 처리
                    errorObj = {};
                    //console.log(validation.getValues());

                }).on('nextfocus', function(e,target){

                    if(target.attr('name') == 'buyerAddrInfo'){
                        setTimeout(function () {
                            $('#buyerAddrBtn').focus();
                        }, 10);                        
                    }

                    if(target.attr('name') == 'recipientAddrInfo'){
                        setTimeout(function () {
                            $('#recipientAddrBtn').focus();
                        }, 10);
                    }

                });

                var checkSerialSuccess = false;

                // 제조번호 확인
                $('#serialCheckBtn').on('input', function(e){
                    checkSerialSuccess = false;
                    if(e.target.value.length > 14){
                        e.target.value = e.target.value.slice(0, 14);
                    }
                })

                $('#serialCheckBtn').on('click', function(e){

                    var serialRegex = /^\d{3}[A-Za-z]{4}[\d\A-Za-z]{5,7}$/ 
                    var checkSerial = serialRegex.test($('#serialNum').val());

                    if(checkSerial) {
                        var test = validation.validate(['modelName','serialNum']);
                        if(test.validItem['modelName']) {
                            lgkorUI.alert("", {title: test.validItem['modelName']});
                        } else {
                            var ajaxUrl = $('#popup').data('skuUrl');
                            var eventId = $('#popup').data('eventId');
                            var values = validation.getValues();
                            if(ajaxUrl, eventId) {
                                var param = {
                                    'modelName':values.modelName,
                                    'serialNum':values.serialNum,
                                    'eventId':eventId
                                }
                                lgkorUI.showLoading();
                                lgkorUI.requestAjaxData(ajaxUrl, null, function(result) {
                                    lgkorUI.hideLoading();
                                    var data = result.data;
                                    if(lgkorUI.stringToBool(data.success)){
                                        checkSerialSucces = true;
                                        lgkorUI.alert("", {title: "제조번호(S/N)가 확인되었습니다."});
                                    } else {
                                        checkSerialSucces = false;
                                    }
                                });
                            }
                        }
                    } else {
                        checkSerialSucces = false;
                        lgkorUI.alert("", {title: "해당 제조번호(S/N)가 존재하지 않습니다.<br>제조번호 확인 후 다시 입력해 주세요."});
                        $('#serialNum').focus();
                    }
                });

                // 구매자 정보와 같음
                $('#info').on('click',function(e){
                    if(e.currentTarget.checked){
                        validation.setValues(addAddressObj);
                    }else{
                        validation.setValues(emptyAddAddressObj);
                    }
                });

                // 구매정보 주소 찾기
                var addressFinder = new AddressFind();

                $('#buyerAddrBtn').on('click', function(e){
                    addressFinder.open(function(data){
                        $('input[name=buyerZipCode]').val(data.zonecode);
                        $('input[name=buyerAddrInfo]').val(data.roadAddress);
                        
                        // 상세정보로 포커스 이동
                        $('input[name=buyerAddrDetail]').focus();
                    });
                });

                // 사은품 주소 찾기
                $('#recipientAddrBtn').on('click', function(e){
                    addressFinder.open(function(data){
                        $('input[name=recipientZipCode]').val(data.zonecode);
                        $('input[name=recipientAddrInfo]').val(data.roadAddress);
                        
                        // 상세정보로 포커스 이동
                        $('input[name=recipientAddrDetail]').focus();
                    });
                });


                // 신청하기
                $('#uiSubmit').on('click', function(){  
                    if(checkSerialSuccess){
                        validation.validate(); 	
                    }else if(errorObj['serialNum']){
                        lgkorUI.alert("", {title: "제조번호(S/N)가 확인해 주세요."});
                        $('#serialCheckBtn').focus(); // 제조번호 확인버튼으로 포커스 이동
                    }else{
                        validation.validate();
                    }
                });

                //// 제품 제조번호 확인방법 

                var modelData = null;
                var modelListData = null;
                var $serialPopupBtn = $('#serialPopupBtn');
                var $serialPopup = $('#serialPopup');

                $serialPopupBtn.on('click', function(e){
                    e.preventDefault();
                    if(!modelData) {
                        var ajaxUrl = $serialPopup.attr('data-list-url');
                        lgkorUI.requestAjaxData(ajaxUrl, null, function(result) {

                            var selectbox = $serialPopup.find('.ui_selectbox:eq(0)');
                            var data = result.data;
                            modelData = data;
                            var arr = data instanceof Array ? data : [];
                            modelListData = vcui.array.reduce(arr, function (prev, cur) {
                                return prev.concat(cur['modelList']);
                            }, []); 

                            var newArr = [{'text':'선택'}];
                            arr.forEach(function(item, index) {
                                newArr.push({'text':item.categoryName, 'value':index});
                            });
                            selectbox.vcSelectbox('update', newArr);
                            $serialPopup.vcModal('open');

                        });


                    } else {
                        var selectbox = $serialPopup.find('.ui_selectbox:eq(0)');
                        selectbox.vcSelectbox('selectedIndex', 0, true);
                        $serialPopup.vcModal('open');
                    }

                });

                //카테고리 선택
                $serialPopup.on('change', '.ui_selectbox:eq(0)', function(e,data){
                    var index = data.selectedIndex;
                    var $selectbox = $serialPopup.find('.ui_selectbox:eq(1)');
                    if(index == 0) {
                        $selectbox.vcSelectbox('disabled', true);
                    } else {
                        $selectbox.vcSelectbox('disabled', false);
                        var mdData = modelData[index-1];
                        var arr = mdData.modelList instanceof Array ? mdData.modelList : [];
                        var newArr = [{'text':'세부 카테고리 선택', 'value':''}]
                        arr.forEach(function(item, index) {
                            newArr.push({'text':item.modelName, 'value':item.modelName});
                        });     

                        $selectbox.vcSelectbox('update', newArr);
                    }
                });

                //모델 선택
                $serialPopup.on('change', '.ui_selectbox:eq(1)', function(e,data){

                    var value = $(this).val();
                    var obj = vcui.array.filterOne(modelListData, function(item, index) {
		                return item['modelName'] === value;
		            });
                    var imageUrl = obj['imageUrl'];
                    var text, imageAlt = obj['imageAlt'];

                    if(vcui.isEmpty(imageUrl)) {
                        text = imageAlt = "제품 이미지 준비중입니다.";
                        imageUrl = "/lg5-common/images/img-nodata.svg";
                    }

                    $serialPopup.find('div.example-result p.txt').text(text);
                    $serialPopup.find('div.example-result img').attr({'src':imageUrl,'alt':imageAlt});
                });
            })

        });
        
    </script>

</body>
</html>