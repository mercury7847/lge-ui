image: docker:latest

variables:
  DEV_WEB_NAS: "/data001/dev-web-nas"

stages:
  - build-n-deploy

dev:
  image: node:10.15.0
  stage: build-n-deploy
  only:
    - dev
  script:
    ## build
    - rm -rf ./dist/*
    - npm install gulp@3.9.1 -g
    - npm install
    - npm audit fix
    - gulp server-build

    ## deploy
    - apt-get update
    - apt-get install rsync -y
    - mkdir -p ${DEV_WEB_NAS}/htdocs
    - rm -rf ${DEV_WEB_NAS}/test-temp
    - mkdir -p ${DEV_WEB_NAS}/test-temp-${CI_COMMIT_SHA}

    - cp -rf ./dist/${CI_COMMIT_SHA}/lg5-common/ ${DEV_WEB_NAS}/test-temp-${CI_COMMIT_SHA}/lg5-common/
